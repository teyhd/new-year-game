<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Сходство изображений</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center px-3 sm:px-4">
  <div class="w-full max-w-6xl mx-auto py-4 sm:py-6">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
        Сходство изображений
      </h1>
      <span class="text-xs md:text-sm text-slate-400">
        By AI - Powered Techs
      </span>
    </header>

    <!-- Main card -->
    <div class="bg-slate-900/70 border border-slate-800 rounded-3xl shadow-2xl shadow-slate-900/60 backdrop-blur p-4 md:p-6 space-y-6">
      <!-- Images + scale -->
      <div class="grid grid-cols-1 sm:grid-cols-[1fr_80px_1fr] md:grid-cols-[1fr_auto_1fr] gap-3 sm:gap-4 md:gap-6 items-stretch">
        <!-- Left image -->
        <div class="relative group rounded-lg sm:rounded-2xl bg-slate-900/80 border border-slate-800 overflow-hidden flex items-center justify-center min-h-[280px] sm:min-h-[350px] md:min-h-auto">
          <img
            src="https://images.pexels.com/photos/2706379/pexels-photo-2706379.jpeg?auto=compress&cs=tinysrgb&w=800"
            alt="Изображение A"
            class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-slate-950/70 via-slate-950/10 to-transparent pointer-events-none"></div>
          <div class="absolute bottom-2 sm:bottom-3 left-2 sm:left-3 right-2 sm:right-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-xs sm:text-sm">
            <span class="px-2 sm:px-3 py-1 rounded-full bg-slate-900/80 border border-slate-700/80">
              Изображение A
            </span>
            <span class="text-slate-400 text-xs">
              исходное
            </span>
          </div>
        </div>

        <!-- Middle similarity scale -->
        <div class="flex flex-col items-center justify-center gap-2 sm:gap-4 px-1 sm:px-2 md:px-4 py-4 sm:py-0">
          <div class="text-xs uppercase tracking-[0.15em] sm:tracking-[0.2em] text-slate-400 text-center">
            Сходство
          </div>

          <div class="relative h-56 sm:h-64 md:h-64 w-12 sm:w-16 md:w-20">
            <!-- Vertical scale background -->
            <div class="absolute inset-0 rounded-full bg-gradient-to-b from-emerald-400/20 via-sky-400/10 to-violet-400/20 border border-slate-700 shadow-inner shadow-slate-950/80"></div>

            <!-- Scale ticks -->
            <div class="absolute inset-2 flex flex-col justify-between text-[8px] sm:text-[10px] text-slate-400">
              <div class="flex flex-col items-center gap-1">
                <span class="font-medium">100%</span>
                <span class="h-px w-3 sm:w-4 bg-slate-500/60"></span>
              </div>
              <div class="flex flex-col items-center gap-1">
                <span class="h-px w-3 sm:w-4 bg-slate-500/60"></span>
                <span class="font-medium">0%</span>
              </div>
            </div>

            <!-- Moving marker -->
            <div
              id="similarityMarker"
              class="absolute left-1/2 -translate-x-1/2 w-8 sm:w-10 h-8 sm:h-10 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-semibold text-white border border-slate-900/60 transition-all duration-200"
              style="bottom: 0%; background-color: rgb(239, 68, 68); box-shadow: 0 0 20px rgba(239, 68, 68, 0.7)"
            >
              <span id="similarityValue">0%</span>
            </div>
          </div>

          <p class="text-[10px] sm:text-xs text-center text-slate-400 max-w-[8rem] sm:max-w-[10rem]">
            Индикатор сходства
          </p>
        </div>

        <!-- Right image -->
        <div class="relative group rounded-lg sm:rounded-2xl bg-slate-900/80 border border-slate-800 overflow-hidden flex items-center justify-center min-h-[280px] sm:min-h-[350px] md:min-h-auto">
          <img
            src="https://images.pexels.com/photos/2706378/pexels-photo-2706378.jpeg?auto=compress&cs=tinysrgb&w=800"
            alt="Изображение B"
            class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-slate-950/70 via-slate-950/10 to-transparent pointer-events-none"></div>
          <div class="absolute bottom-2 sm:bottom-3 left-2 sm:left-3 right-2 sm:right-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-xs sm:text-sm">
            <span class="px-2 sm:px-3 py-1 rounded-full bg-slate-900/80 border border-slate-700/80">
              Изображение B
            </span>
            <span class="text-slate-400 text-xs">
              сравниваемое
            </span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-4 pt-4 sm:pt-2 border-t border-slate-800/80">
        <p class="text-xs sm:text-sm text-slate-400 order-2 sm:order-1">
          Нажмите «Сравнить» для анализа. Показатель плавно увеличится до результата.
        </p>

        <button
          id="analyzeButton"
          class="relative inline-flex items-center justify-center gap-2 rounded-full bg-sky-500 hover:bg-sky-400 active:bg-sky-500 disabled:opacity-60 disabled:cursor-not-allowed px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-semibold shadow-lg shadow-sky-500/30 transition whitespace-nowrap order-1 sm:order-2"
        >
          <span
            id="buttonSpinner"
            class="hidden h-4 w-4 border-2 border-slate-900/30 border-t-slate-50 rounded-full animate-spin"
          ></span>
          <span id="buttonLabel">Начать анализ</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const marker = document.getElementById("similarityMarker");
    const similarityValueEl = document.getElementById("similarityValue");
    const analyzeButton = document.getElementById("analyzeButton");
    const buttonSpinner = document.getElementById("buttonSpinner");
    const buttonLabel = document.getElementById("buttonLabel");

    let currentSimilarity = 0;   // 0–100
    let isLoading = false;
    const ANIMATION_DURATION = 3000; // Время анимации в миллисекундах (3 сек)

    // Функция для расчета цвета: от красного (0%) к зеленому (100%)
    function getColorForPercent(percent) {
      const clamped = Math.max(0, Math.min(100, percent));
      const ratio = clamped / 100;
      
      // Красный (255, 0, 0) → Зелёный (34, 197, 94)
      const r = Math.round(239 - (239 - 34) * ratio);
      const g = Math.round(0 + (197 - 0) * ratio);
      const b = Math.round(68 - (68 - 94) * ratio);
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    function updateSimilarityDisplay(percent) {
      const clamped = Math.max(0, Math.min(100, Math.round(percent)));
      similarityValueEl.textContent = clamped + "%";
      marker.style.bottom = clamped + "%";
      
      // Обновляем цвет шарика
      const newColor = getColorForPercent(clamped);
      marker.style.backgroundColor = newColor;
      marker.style.boxShadow = `0 0 20px ${newColor}`;
    }
    function animateSimilarityTo(targetPercent, duration = ANIMATION_DURATION) {
      const startValue = currentSimilarity;
      const endValue = Math.max(0, Math.min(100, targetPercent));
      const startTime = performance.now();

      function frame(now) {
        const t = Math.min(1, (now - startTime) / duration);
        // лёгкое ease-out
        const eased = 1 - Math.pow(1 - t, 3);
        const value = startValue + (endValue - startValue) * eased;
        updateSimilarityDisplay(value);

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          currentSimilarity = endValue;
        }
      }

      requestAnimationFrame(frame);
    }

    async function runAnalysis() {
      if (isLoading) return;
      isLoading = true;

      analyzeButton.disabled = true;
      buttonSpinner.classList.remove("hidden");
      buttonLabel.textContent = "Идёт анализ…";

      try {
        // Пример запроса к вашему бэкенду /prz
        const response = await fetch("/prz", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
         
        });

        let targetPercent = 0;

        if (response.ok) {
          const data = await response.json();
          // Ожидается, что бэкенд вернёт число от 0 до 1 или сразу от 0 до 100
          let raw = data.percentage ?? data.score ?? 0;

          if (raw <= 1) {
            targetPercent = Math.round(raw * 100);
          } else {
            targetPercent = Math.round(raw);
          }
        } else {
          // fallback, если /prz вернул ошибку
          console.error("Ошибка ответа /prz:", response.status);
          targetPercent = 67; // заглушка
        }

        animateSimilarityTo(targetPercent);
      } catch (err) {
        console.error("Ошибка запроса /prz:", err);
        // fallback на случай сетевой ошибки
        animateSimilarityTo(54);
      } finally {
        isLoading = false;
        analyzeButton.disabled = false;
        buttonSpinner.classList.add("hidden");
        buttonLabel.textContent = "Повторить анализ";
      }
    }

    analyzeButton.addEventListener("click", runAnalysis);
  </script>
</body>
</html>